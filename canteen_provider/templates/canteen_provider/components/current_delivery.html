<div id="live_connection">
    Creating Connection.......!! Please wait
</div>

<div id="order_items"></div>
    <!-- Items to be displayed here -->
</div>

<button onclick="getNewOTP()">Get New OTP</button>

<script>
    const chatSocket = new WebSocket("ws://" + window.location.host + "/");
    const otp = document.querySelector("#live_connection");
    const orderItemsDiv = document.querySelector("#order_items");

    chatSocket.onopen = function (e) {
        console.log("Connection for current_deliver Established!");
        otp.innerHTML = "Connection Established ! Please Wait.....";
        getNewOTP();
    };

    function getNewOTP() {
        otp.innerHTML = "Getting New OTP";
        chatSocket.send(JSON.stringify({
            'type': 'get_new_otp',
            'message': 'get_new_otp'
        }));
    }

    function sendDelivered(orderId) {
        chatSocket.send(JSON.stringify({
            'type': 'delivered',
            'order_id': orderId
        }));
    }

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data);
        console.log(data.type)
        if (data.type == "new_otp") {

            // otp.innerHTML = data.otp;
            console.log(data)
            console.log("New OTP : " + data.otp)
            otp.innerHTML = "New OTP : " + data.otp;

        } else if (data.type == "delivered") {
            otp.innerHTML = "Items Delivered";
            // get username and maybe otp too
        } else if (data.type == "error") {
            otp.innerHTML = "Error : " + data.message;
        } else if (data.type == "order_items") {
            console.log(data.message)
            updateOrderItems(data.message);
        }
    };

    {% comment %} function updateOrderItems(items) {
        orderItemsDiv.innerHTML = "";
        Object.entries(items).forEach(([key, value]) => {
            const itemDiv = document.createElement("div");
            itemDiv.innerHTML = `
                <h3>${value.name}</h3>
                <p>Quantity : ${value.quantity}</p>
                <p>Price : ${value.price}</p>
                <button onclick="sendDelivered(${value.id})">Delivered</button>
            `;
            orderItemsDiv.appendChild(itemDiv);
        });
    } {% endcomment %}
</script>


{% comment %} Make a delivery avalability submittable form and refresh every time {% endcomment %}